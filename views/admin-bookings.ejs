<div class="row mb-4">
  <div class="col-md-8">
    <h1>Manage Bookings</h1>
  </div>
  <div class="col-md-4 text-end">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addBookingModal">
      <i class="bi bi-plus-circle"></i> Add New Booking
    </button>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="bookings-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="true">All Bookings</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button" role="tab" aria-controls="upcoming" aria-selected="false">Upcoming</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button" role="tab" aria-controls="past" aria-selected="false">Past</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled" type="button" role="tab" aria-controls="cancelled" aria-selected="false">Cancelled</button>
          </li>
        </ul>
      </div>
      <div class="card-body">
        <div class="tab-content" id="bookings-tabs-content">
          <div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tab">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Room</th>
                    <th>User</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="all-bookings-table-body">
                  <!-- Bookings will be loaded here -->
                  <tr>
                    <td colspan="8" class="text-center">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="upcoming" role="tabpanel" aria-labelledby="upcoming-tab">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Room</th>
                    <th>User</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="upcoming-bookings-table-body">
                  <!-- Upcoming bookings will be loaded here -->
                  <tr>
                    <td colspan="8" class="text-center">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="past" role="tabpanel" aria-labelledby="past-tab">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Room</th>
                    <th>User</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="past-bookings-table-body">
                  <!-- Past bookings will be loaded here -->
                  <tr>
                    <td colspan="8" class="text-center">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="cancelled" role="tabpanel" aria-labelledby="cancelled-tab">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Room</th>
                    <th>User</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="cancelled-bookings-table-body">
                  <!-- Cancelled bookings will be loaded here -->
                  <tr>
                    <td colspan="8" class="text-center">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Calendar View</h5>
      </div>
      <div class="card-body">
        <div id="calendar"></div>
      </div>
    </div>
  </div>
</div>

<!-- Add Booking Modal -->
<div class="modal fade" id="addBookingModal" tabindex="-1" aria-labelledby="addBookingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addBookingModalLabel">Add New Booking</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-booking-form">
          <div class="mb-3">
            <label for="booking-title" class="form-label">Title</label>
            <input type="text" class="form-control" id="booking-title" required>
          </div>
          <div class="mb-3">
            <label for="booking-room" class="form-label">Room</label>
            <select class="form-select" id="booking-room" required>
              <option value="">Select a room</option>
              <!-- Rooms will be loaded here -->
            </select>
          </div>
          <div class="mb-3">
            <label for="booking-user" class="form-label">User</label>
            <select class="form-select" id="booking-user" required>
              <option value="">Select a user</option>
              <!-- Users will be loaded here -->
            </select>
          </div>
          <div class="mb-3">
            <label for="booking-description" class="form-label">Description</label>
            <textarea class="form-control" id="booking-description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="booking-date" class="form-label">Date</label>
            <input type="date" class="form-control" id="booking-date" required>
          </div>
          <div class="row mb-3">
            <div class="col">
              <label for="booking-start-time" class="form-label">Start Time</label>
              <input type="time" class="form-control" id="booking-start-time" required>
            </div>
            <div class="col">
              <label for="booking-end-time" class="form-label">End Time</label>
              <input type="time" class="form-control" id="booking-end-time" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="booking-status" class="form-label">Status</label>
            <select class="form-select" id="booking-status" required>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-booking-btn">Save Booking</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Booking Modal -->
<div class="modal fade" id="editBookingModal" tabindex="-1" aria-labelledby="editBookingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editBookingModalLabel">Edit Booking</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-booking-form">
          <input type="hidden" id="edit-booking-id">
          <div class="mb-3">
            <label for="edit-booking-title" class="form-label">Title</label>
            <input type="text" class="form-control" id="edit-booking-title" required>
          </div>
          <div class="mb-3">
            <label for="edit-booking-room" class="form-label">Room</label>
            <select class="form-select" id="edit-booking-room" required>
              <option value="">Select a room</option>
              <!-- Rooms will be loaded here -->
            </select>
          </div>
          <div class="mb-3">
            <label for="edit-booking-user" class="form-label">User</label>
            <select class="form-select" id="edit-booking-user" required>
              <option value="">Select a user</option>
              <!-- Users will be loaded here -->
            </select>
          </div>
          <div class="mb-3">
            <label for="edit-booking-description" class="form-label">Description</label>
            <textarea class="form-control" id="edit-booking-description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="edit-booking-date" class="form-label">Date</label>
            <input type="date" class="form-control" id="edit-booking-date" required>
          </div>
          <div class="row mb-3">
            <div class="col">
              <label for="edit-booking-start-time" class="form-label">Start Time</label>
              <input type="time" class="form-control" id="edit-booking-start-time" required>
            </div>
            <div class="col">
              <label for="edit-booking-end-time" class="form-label">End Time</label>
              <input type="time" class="form-control" id="edit-booking-end-time" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="edit-booking-status" class="form-label">Status</label>
            <select class="form-select" id="edit-booking-status" required>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="update-booking-btn">Update Booking</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Booking Confirmation Modal -->
<div class="modal fade" id="deleteBookingModal" tabindex="-1" aria-labelledby="deleteBookingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteBookingModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this booking? This action cannot be undone.</p>
        <input type="hidden" id="delete-booking-id">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-booking-btn">Delete Booking</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize calendar
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: function(info, successCallback, failureCallback) {
        fetch('/api/bookings')
          .then(response => response.json())
          .then(data => {
            const events = data.map(booking => ({
              id: booking.id,
              title: booking.title,
              start: booking.start_time,
              end: booking.end_time,
              extendedProps: {
                room: booking.room_name,
                user: booking.user_username,
                description: booking.description,
                status: booking.status
              },
              backgroundColor: getStatusColor(booking.status)
            }));
            successCallback(events);
          })
          .catch(error => {
            console.error('Error fetching bookings:', error);
            failureCallback(error);
          });
      },
      eventClick: function(info) {
        openEditBookingModal(info.event.id);
      }
    });
    
    calendar.render();
    
    // Load data
    loadBookings();
    loadRooms();
    loadUsers();
    
    // Add booking event handler
    document.getElementById('save-booking-btn').addEventListener('click', function() {
      const title = document.getElementById('booking-title').value;
      const room_id = document.getElementById('booking-room').value;
      const user_id = document.getElementById('booking-user').value;
      const description = document.getElementById('booking-description').value;
      const date = document.getElementById('booking-date').value;
      const start_time = document.getElementById('booking-start-time').value;
      const end_time = document.getElementById('booking-end-time').value;
      const status = document.getElementById('booking-status').value;
      
      if (!title || !room_id || !user_id || !date || !start_time || !end_time) {
        alert('Title, room, user, date, start time, and end time are required');
        return;
      }
      
      const startDateTime = new Date(`${date}T${start_time}`);
      const endDateTime = new Date(`${date}T${end_time}`);
      
      // Validate times
      if (endDateTime <= startDateTime) {
        alert('End time must be after start time');
        return;
      }
      
      fetch('/api/bookings', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          room_id: parseInt(room_id),
          user_id: parseInt(user_id),
          description,
          start_time: startDateTime.toISOString(),
          end_time: endDateTime.toISOString(),
          status
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'Failed to create booking');
          });
        }
        return response.json();
      })
      .then(data => {
        // Close modal and reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('addBookingModal'));
        modal.hide();
        document.getElementById('add-booking-form').reset();
        
        // Reload bookings and calendar
        loadBookings();
        calendar.refetchEvents();
        
        // Show success message
        alert('Booking created successfully');
      })
      .catch(error => {
        console.error('Error creating booking:', error);
        alert('Error creating booking: ' + error.message);
      });
    });
    
    // Update booking event handler
    document.getElementById('update-booking-btn').addEventListener('click', function() {
      const id = document.getElementById('edit-booking-id').value;
      const title = document.getElementById('edit-booking-title').value;
      const room_id = document.getElementById('edit-booking-room').value;
      const user_id = document.getElementById('edit-booking-user').value;
      const description = document.getElementById('edit-booking-description').value;
      const date = document.getElementById('edit-booking-date').value;
      const start_time = document.getElementById('edit-booking-start-time').value;
      const end_time = document.getElementById('edit-booking-end-time').value;
      const status = document.getElementById('edit-booking-status').value;
      
      if (!title || !room_id || !user_id || !date || !start_time || !end_time) {
        alert('Title, room, user, date, start time, and end time are required');
        return;
      }
      
      const startDateTime = new Date(`${date}T${start_time}`);
      const endDateTime = new Date(`${date}T${end_time}`);
      
      // Validate times
      if (endDateTime <= startDateTime) {
        alert('End time must be after start time');
        return;
      }
      
      fetch(`/api/bookings/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          room_id: parseInt(room_id),
          user_id: parseInt(user_id),
          description,
          start_time: startDateTime.toISOString(),
          end_time: endDateTime.toISOString(),
          status
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'Failed to update booking');
          });
        }
        return response.json();
      })
      .then(data => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editBookingModal'));
        modal.hide();
        
        // Reload bookings and calendar
        loadBookings();
        calendar.refetchEvents();
        
        // Show success message
        alert('Booking updated successfully');
      })
      .catch(error => {
        console.error('Error updating booking:', error);
        alert('Error updating booking: ' + error.message);
      });
    });
    
    // Delete booking event handler
    document.getElementById('confirm-delete-booking-btn').addEventListener('click', function() {
      const id = document.getElementById('delete-booking-id').value;
      
      fetch(`/api/bookings/${id}`, {
        method: 'DELETE'
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to delete booking');
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteBookingModal'));
        modal.hide();
        
        // Reload bookings and calendar
        loadBookings();
        calendar.refetchEvents();
        
        // Show success message
        alert('Booking deleted successfully');
      })
      .catch(error => {
        console.error('Error deleting booking:', error);
        alert('Error deleting booking: ' + error.message);
      });
    });
    
    // Tab change event handler
    document.querySelectorAll('#bookings-tabs button').forEach(button => {
      button.addEventListener('click', function() {
        // No need to reload data, it's already loaded
      });
    });
    
    // Function to load bookings
    function loadBookings() {
      fetch('/api/bookings')
        .then(response => response.json())
        .then(bookings => {
          const now = new Date();
          
          // Filter bookings
          const upcomingBookings = bookings.filter(booking => 
            new Date(booking.start_time) > now && booking.status !== 'cancelled'
          );
          
          const pastBookings = bookings.filter(booking => 
            new Date(booking.end_time) < now && booking.status !== 'cancelled'
          );
          
          const cancelledBookings = bookings.filter(booking => 
            booking.status === 'cancelled'
          );
          
          // Display bookings
          displayBookings('all-bookings-table-body', bookings);
          displayBookings('upcoming-bookings-table-body', upcomingBookings);
          displayBookings('past-bookings-table-body', pastBookings);
          displayBookings('cancelled-bookings-table-body', cancelledBookings);
        })
        .catch(error => {
          console.error('Error fetching bookings:', error);
          document.getElementById('all-bookings-table-body').innerHTML = `
            <tr>
              <td colspan="8" class="text-center text-danger">
                Error loading bookings. Please try again later.
              </td>
            </tr>
          `;
        });
    }
    
    // Function to display bookings
    function displayBookings(containerId, bookings) {
      const container = document.getElementById(containerId);
      
      if (!bookings || bookings.length === 0) {
        container.innerHTML = `
          <tr>
            <td colspan="8" class="text-center">No bookings found</td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      bookings.forEach(booking => {
        const startTime = new Date(booking.start_time);
        const endTime = new Date(booking.end_time);
        
        html += `
          <tr>
            <td>${booking.id}</td>
            <td>${booking.title}</td>
            <td>${booking.room_name}</td>
            <td>${booking.user_username}</td>
            <td>${formatDateTime(startTime)}</td>
            <td>${formatDateTime(endTime)}</td>
            <td><span class="badge bg-${getStatusClass(booking.status)}">${booking.status}</span></td>
            <td>
              <button class="btn btn-sm btn-primary edit-booking-btn" data-booking-id="${booking.id}">
                <i class="bi bi-pencil"></i> Edit
              </button>
              <button class="btn btn-sm btn-danger delete-booking-btn" data-booking-id="${booking.id}">
                <i class="bi bi-trash"></i> Delete
              </button>
            </td>
          </tr>
        `;
      });
      
      container.innerHTML = html;
      
      // Add event listeners to edit buttons
      container.querySelectorAll('.edit-booking-btn').forEach(button => {
        button.addEventListener('click', function() {
          const bookingId = this.getAttribute('data-booking-id');
          openEditBookingModal(bookingId);
        });
      });
      
      // Add event listeners to delete buttons
      container.querySelectorAll('.delete-booking-btn').forEach(button => {
        button.addEventListener('click', function() {
          const bookingId = this.getAttribute('data-booking-id');
          openDeleteBookingModal(bookingId);
        });
      });
    }
    
    // Function to load rooms
    function loadRooms() {
      fetch('/api/rooms')
        .then(response => response.json())
        .then(rooms => {
          const addRoomSelect = document.getElementById('booking-room');
          const editRoomSelect = document.getElementById('edit-booking-room');
          
          let options = '<option value="">Select a room</option>';
          rooms.forEach(room => {
            options += `<option value="${room.id}">${room.name} (Capacity: ${room.capacity})</option>`;
          });
          
          addRoomSelect.innerHTML = options;
          editRoomSelect.innerHTML = options;
        })
        .catch(error => {
          console.error('Error fetching rooms:', error);
        });
    }
    
    // Function to load users
    function loadUsers() {
      fetch('/api/users')
        .then(response => response.json())
        .then(users => {
          const addUserSelect = document.getElementById('booking-user');
          const editUserSelect = document.getElementById('edit-booking-user');
          
          let options = '<option value="">Select a user</option>';
          users.forEach(user => {
            options += `<option value="${user.id}">${user.username} (${user.full_name || user.email})</option>`;
          });
          
          addUserSelect.innerHTML = options;
          editUserSelect.innerHTML = options;
        })
        .catch(error => {
          console.error('Error fetching users:', error);
        });
    }
    
    // Function to open edit booking modal
    function openEditBookingModal(bookingId) {
      fetch(`/api/bookings/${bookingId}`)
        .then(response => response.json())
        .then(booking => {
          const startTime = new Date(booking.start_time);
          const endTime = new Date(booking.end_time);
          
          document.getElementById('edit-booking-id').value = booking.id;
          document.getElementById('edit-booking-title').value = booking.title;
          document.getElementById('edit-booking-room').value = booking.room_id;
          document.getElementById('edit-booking-user').value = booking.user_id;
          document.getElementById('edit-booking-description').value = booking.description || '';
          document.getElementById('edit-booking-date').value = startTime.toISOString().split('T')[0];
          document.getElementById('edit-booking-start-time').value = startTime.toTimeString().slice(0, 5);
          document.getElementById('edit-booking-end-time').value = endTime.toTimeString().slice(0, 5);
          document.getElementById('edit-booking-status').value = booking.status;
          
          const modal = new bootstrap.Modal(document.getElementById('editBookingModal'));
          modal.show();
        })
        .catch(error => {
          console.error('Error fetching booking details:', error);
          alert('Error fetching booking details: ' + error.message);
        });
    }
    
    // Function to open delete booking modal
    function openDeleteBookingModal(bookingId) {
      document.getElementById('delete-booking-id').value = bookingId;
      const modal = new bootstrap.Modal(document.getElementById('deleteBookingModal'));
      modal.show();
    }
    
    // Helper function to format date and time
    function formatDateTime(date) {
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    }
    
    // Helper function to get status color
    function getStatusColor(status) {
      switch(status) {
        case 'confirmed':
          return '#28a745'; // green
        case 'pending':
          return '#ffc107'; // yellow
        case 'cancelled':
          return '#dc3545'; // red
        default:
          return '#007bff'; // blue
      }
    }
    
    // Helper function to get status class
    function getStatusClass(status) {
      switch(status) {
        case 'confirmed':
          return 'success';
        case 'pending':
          return 'warning';
        case 'cancelled':
          return 'danger';
        default:
          return 'primary';
      }
    }
  });
</script>

<style>
  #calendar {
    height: 600px;
  }
</style>