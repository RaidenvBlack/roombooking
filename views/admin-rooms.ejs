<div class="row mb-4">
  <div class="col-md-8">
    <h1>Manage Rooms</h1>
  </div>
  <div class="col-md-4 text-end">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addRoomModal">
      <i class="bi bi-plus-circle"></i> Add New Room
    </button>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Room List</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Capacity</th>
                <th>Location</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rooms-table-body">
              <!-- Rooms will be loaded here -->
              <tr>
                <td colspan="6" class="text-center">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Room Modal -->
<div class="modal fade" id="addRoomModal" tabindex="-1" aria-labelledby="addRoomModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addRoomModalLabel">Add New Room</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-room-form">
          <div class="mb-3">
            <label for="room-name" class="form-label">Room Name</label>
            <input type="text" class="form-control" id="room-name" required>
          </div>
          <div class="mb-3">
            <label for="room-capacity" class="form-label">Capacity</label>
            <input type="number" class="form-control" id="room-capacity" min="1" required>
          </div>
          <div class="mb-3">
            <label for="room-location" class="form-label">Location</label>
            <input type="text" class="form-control" id="room-location">
          </div>
          <div class="mb-3">
            <label for="room-description" class="form-label">Description</label>
            <textarea class="form-control" id="room-description" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-room-btn">Save Room</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Room Modal -->
<div class="modal fade" id="editRoomModal" tabindex="-1" aria-labelledby="editRoomModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editRoomModalLabel">Edit Room</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-room-form">
          <input type="hidden" id="edit-room-id">
          <div class="mb-3">
            <label for="edit-room-name" class="form-label">Room Name</label>
            <input type="text" class="form-control" id="edit-room-name" required>
          </div>
          <div class="mb-3">
            <label for="edit-room-capacity" class="form-label">Capacity</label>
            <input type="number" class="form-control" id="edit-room-capacity" min="1" required>
          </div>
          <div class="mb-3">
            <label for="edit-room-location" class="form-label">Location</label>
            <input type="text" class="form-control" id="edit-room-location">
          </div>
          <div class="mb-3">
            <label for="edit-room-description" class="form-label">Description</label>
            <textarea class="form-control" id="edit-room-description" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="update-room-btn">Update Room</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Room Confirmation Modal -->
<div class="modal fade" id="deleteRoomModal" tabindex="-1" aria-labelledby="deleteRoomModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteRoomModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this room? This action cannot be undone.</p>
        <p><strong>Note:</strong> All bookings associated with this room will also be deleted.</p>
        <input type="hidden" id="delete-room-id">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-room-btn">Delete Room</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Load rooms
    loadRooms();
    
    // Add room event handler
    document.getElementById('save-room-btn').addEventListener('click', function() {
      const name = document.getElementById('room-name').value;
      const capacity = document.getElementById('room-capacity').value;
      const location = document.getElementById('room-location').value;
      const description = document.getElementById('room-description').value;
      
      if (!name || !capacity) {
        alert('Room name and capacity are required');
        return;
      }
      
      fetch('/api/rooms', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name,
          capacity: parseInt(capacity),
          location,
          description
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to create room');
        }
        return response.json();
      })
      .then(data => {
        // Close modal and reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('addRoomModal'));
        modal.hide();
        document.getElementById('add-room-form').reset();
        
        // Reload rooms
        loadRooms();
        
        // Show success message
        alert('Room created successfully');
      })
      .catch(error => {
        console.error('Error creating room:', error);
        alert('Error creating room: ' + error.message);
      });
    });
    
    // Update room event handler
    document.getElementById('update-room-btn').addEventListener('click', function() {
      const id = document.getElementById('edit-room-id').value;
      const name = document.getElementById('edit-room-name').value;
      const capacity = document.getElementById('edit-room-capacity').value;
      const location = document.getElementById('edit-room-location').value;
      const description = document.getElementById('edit-room-description').value;
      
      if (!name || !capacity) {
        alert('Room name and capacity are required');
        return;
      }
      
      fetch(`/api/rooms/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name,
          capacity: parseInt(capacity),
          location,
          description
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to update room');
        }
        return response.json();
      })
      .then(data => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editRoomModal'));
        modal.hide();
        
        // Reload rooms
        loadRooms();
        
        // Show success message
        alert('Room updated successfully');
      })
      .catch(error => {
        console.error('Error updating room:', error);
        alert('Error updating room: ' + error.message);
      });
    });
    
    // Delete room event handler
    document.getElementById('confirm-delete-room-btn').addEventListener('click', function() {
      const id = document.getElementById('delete-room-id').value;
      
      fetch(`/api/rooms/${id}`, {
        method: 'DELETE'
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to delete room');
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteRoomModal'));
        modal.hide();
        
        // Reload rooms
        loadRooms();
        
        // Show success message
        alert('Room deleted successfully');
      })
      .catch(error => {
        console.error('Error deleting room:', error);
        alert('Error deleting room: ' + error.message);
      });
    });
    
    // Function to load rooms
    function loadRooms() {
      fetch('/api/rooms')
        .then(response => response.json())
        .then(rooms => {
          const tableBody = document.getElementById('rooms-table-body');
          
          if (rooms.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" class="text-center">No rooms found</td>
              </tr>
            `;
            return;
          }
          
          let html = '';
          rooms.forEach(room => {
            html += `
              <tr>
                <td>${room.id}</td>
                <td>${room.name}</td>
                <td>${room.capacity}</td>
                <td>${room.location || 'N/A'}</td>
                <td>${moment(room.created_at).format('YYYY-MM-DD')}</td>
                <td>
                  <button class="btn btn-sm btn-primary edit-room-btn" data-room-id="${room.id}">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-danger delete-room-btn" data-room-id="${room.id}">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </td>
              </tr>
            `;
          });
          
          tableBody.innerHTML = html;
          
          // Add event listeners to edit buttons
          document.querySelectorAll('.edit-room-btn').forEach(button => {
            button.addEventListener('click', function() {
              const roomId = this.getAttribute('data-room-id');
              openEditRoomModal(roomId);
            });
          });
          
          // Add event listeners to delete buttons
          document.querySelectorAll('.delete-room-btn').forEach(button => {
            button.addEventListener('click', function() {
              const roomId = this.getAttribute('data-room-id');
              openDeleteRoomModal(roomId);
            });
          });
        })
        .catch(error => {
          console.error('Error fetching rooms:', error);
          document.getElementById('rooms-table-body').innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-danger">
                Error loading rooms. Please try again later.
              </td>
            </tr>
          `;
        });
    }
    
    // Function to open edit room modal
    function openEditRoomModal(roomId) {
      fetch(`/api/rooms/${roomId}`)
        .then(response => response.json())
        .then(room => {
          document.getElementById('edit-room-id').value = room.id;
          document.getElementById('edit-room-name').value = room.name;
          document.getElementById('edit-room-capacity').value = room.capacity;
          document.getElementById('edit-room-location').value = room.location || '';
          document.getElementById('edit-room-description').value = room.description || '';
          
          const modal = new bootstrap.Modal(document.getElementById('editRoomModal'));
          modal.show();
        })
        .catch(error => {
          console.error('Error fetching room details:', error);
          alert('Error fetching room details: ' + error.message);
        });
    }
    
    // Function to open delete room modal
    function openDeleteRoomModal(roomId) {
      document.getElementById('delete-room-id').value = roomId;
      const modal = new bootstrap.Modal(document.getElementById('deleteRoomModal'));
      modal.show();
    }
  });
</script>